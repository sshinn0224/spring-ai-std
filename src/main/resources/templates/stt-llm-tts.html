<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spring AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <link href="/css/springai.css" rel="stylesheet" />
  <script src="/js/springai.js"></script>
  <script>
    // 도큐먼트 로드 이벤트 핸들러 설정
    document.addEventListener("DOMContentLoaded", () => {
      startQuestion();
    });

    // 질문 시작하기
    function startQuestion() {
      // 마이크 초기화
      springai.voice.initMic(handleVoice);  

      // 사용자가 음성을 입력할 차례임을 알려주는 UI 추가
      user_uuid = springai.voice.addUserQuestionPlaceHolder("chatPanel");      
    }

    // 사용자의 음성이 입력되었을 경우 처리하는 함수
    async function handleVoice(mp3Blob) {
      try {
        //스피너 보여주기
        springai.setSpinner("spinner", true);

        // 멀티파트 폼 구성
        const formData = new FormData();
        formData.append("speech", mp3Blob, 'speech.mp3');

        // 녹화된 음성을 텍스트로 변환 요청
        const response = await fetch("/ai/stt", {
          method: "post",
          headers: {
            // Content-Type은 자동 생성되는 것을 사용해야함(파트 구분선 포함)
            'Accept': 'text/plain'
          },
          body: formData
        });

        // 텍스트 질문을 채팅 패널에 보여주기
        const questionText = await response.text();
        const uuidElement = document.getElementById(user_uuid);
        uuidElement.innerHTML = questionText;
        springai.scrollToHeight("chatPanel");

        // 대화 하기
        await chat(questionText);
      } catch (error) {
        //스피너 숨기기
        springai.setSpinner("spinner", false);
        console.log(error);
      } finally {
        // 음성 질문 스피커 애니메이션 중지
        springai.voice.controlSpeakerAnimation(user_uuid + "-speaker", false);
      }
    }

    // 텍스트 질문에 대해 텍스트 및 음성 응답 얻기
    async function chat(questionText) {
      // 텍스트 질문에 대해 답변을 요청
      const response = await fetch("/ai/chat-text", {
        method: "post",
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json'
        },
        body: new URLSearchParams({ question: questionText })
      });

      // AI 답변을 보여줄 엘리먼트를 채팅 패널에 추가하기
      ai_uuid = springai.voice.addAnswerPlaceHolder("chatPanel");

      // 응답 JSON 받기
      const answerJson = await response.json();
      console.log(answerJson);

      //음성 답변을 재생하기 위한 소스 설정
      const audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.src = "data:audio/mp3;base64," + answerJson.audio;

      //음성 답변이 재생 시작되면 콜백되는 함수 등록
      audioPlayer.addEventListener("play", () => {
        //텍스트 답변을 채팅 패널에 보여주기
        document.getElementById(ai_uuid).innerHTML = answerJson.text;
        springai.scrollToHeight("chatPanel");
      }, { once: true });

      //음성 답변이 재생 완료되었을 때 콜백되는 함수 등록
      audioPlayer.addEventListener("ended", () => {
        // 음성 답변 스피커 애니메이션 중지
        springai.voice.controlSpeakerAnimation(ai_uuid + "-speaker", false);
        // 스피너 숨기기
        springai.setSpinner("spinner", false);
        console.log("대화 종료");
        // 음성 질문 다시 받기
        startQuestion();
      }, { once: true });

      audioPlayer.play();
    }


  </script>
</head>

<body>
  <div class="d-flex flex-column vh-100">
    <nav class="navbar justify-content-between">
      <a href="/" class="navbar-brand ps-2">
        <img src="/image/spring_ai_logo_with_text.svg" width="200" />
      </a>
      <div id="spinner" class="spinner-border text-success d-none me-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </nav>

    <div id="chatPanel" class="flex-grow-1 container-fluid h-100 my-2" style="overflow-y:auto; overflow-x:hidden;">
      <div class="d-flex justify-content-start border-bottom m-2">
        <table>
          <tr>
            <td><img src="/image/assistant.png" width="50" /></td>
            <td><span>음성으로 질문을 해주세요.</span></td>
          </tr>
        </table>
        <audio id="audioPlayer" controls style="display:none;"></audio>
      </div>
    </div>

    <div id="inputPanel" class="bg-secondary-subtle">
      <div class="input-group p-2">
        <span class="input-group-text">질문</span>
        <input id="question" type="text" class="form-control" value="음성으로 질문해 주세요" disabled />
      </div>
    </div>
  </div>
</body>

</html>