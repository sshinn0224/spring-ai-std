<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spring AI</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
	<link href="/css/springai.css" rel="stylesheet" />
  <script src="/js/springai.js"></script>
  <script>
    //##### Speech To Text #####
    async function stt() {
      //multipart/form-data 구성
      const speech = document.getElementById("audioInput").files[0];
      const formData = new FormData();
      formData.append('speech', speech);

      // 스피터 보여주기
      springai.setSpinner("spinner", true);

      //AJAX 통신하기
      const response = await fetch('/ai/stt', {
        method: "post",
				headers: {
					//Content-Type은 자동 생성되는 것을 사용해야함(파트 구분선 포함)
					'Accept': 'text/plain'
				},
        body: formData
      });

      //텍스트 질문을 chatPanel에 보여주기
      const text = await response.text();
      const textPlaceHolder = document.getElementById("textPlaceHolder");
      textPlaceHolder.innerHTML = text;

      //스피너 숨기기
      springai.setSpinner("spinner", false);
    }

    // ##### Text To Speech #####
    async function tts() {
      // 텍스트 얻기
      const text = document.getElementById("textInput").value;

      // 스피터 보여주기
      springai.setSpinner("spinner", true);

      // AJAX 통신하기
      const response = await fetch('/ai/tts', {
        method: "post",
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
					'Accept': 'application/octet-stream'
				},				
        body: new URLSearchParams({ text: text })
      });

      // 음성 재생
      const audioPlayer = document.getElementById("audioPlayer");
      springai.voice.playAudioFormStreamingData(response, audioPlayer);

      //오디오 재생이 시작되면 스피너 숨기기
      audioPlayer.addEventListener("play", () => {
        springai.setSpinner("spinner", false);
      }, { once: true });	

      
    }
  </script>
</head>

<body>
  <div class="d-flex flex-column vh-100">
    <nav class="navbar justify-content-between">
      <a href="/" class="navbar-brand ps-2">
        <img src="/image/spring_ai_logo_with_text.svg" width="200" />
      </a>
      <div id="spinner" class="spinner-border text-success d-none me-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>      
    </nav>

    <div class="flex-grow-1 container-fluid h-100 my-2" style="overflow-y:auto; overflow-x:hidden;">
      <div class="card">
        <div class="card-header">STT 테스트</div>
        <div class="card-body">
          <label>오디오 입력</label>
          <div class="input-group p-2">
            <input id="audioInput" type="file" class="form-control">
            <button type="button" class="btn btn-info btn-sm" onclick="stt()">제출</button>
          </div>
          <hr />
          <div class="input-group p-2">
            <span class="input-group-text">변환된 텍스트</span>
            <textarea id="textPlaceHolder" class="form-control"></textarea>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">TTS 테스트</div>
        <div class="card-body">
          <div class="input-group p-2">
            <span class="input-group-text">텍스트 입력</span>
            <textarea id="textInput" class="form-control"></textarea>
            <button type="button" class="btn btn-info btn-sm" onclick="tts()">제출</button>
          </div>
          <hr />
          <div class="input-group p-2">
            <span class="input-group-text me-2">변환된 음성</span>
            <audio id="audioPlayer" controls></audio>
          </div>
        </div>
      </div>
    </div>
</body>

</html>